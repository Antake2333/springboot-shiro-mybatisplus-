<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.antake.mapper.UserMapper">
    <select id="getUserInfoByUsername" resultMap="userInfoMap">
        SELECT id,
               username,
               `password`,
               salt,
               `name`,
               phone,
               sex,
               email,
               login_time,
               description,
               `status`,
               create_id,
               update_id,
               gmt_create,
               gmt_modified
        FROM `user`
        WHERE username = #{username}
          and deleted = 0
    </select>
    <resultMap id="userInfoMap" type="com.antake.vo.JwtUser">
        <id column="id" property="id"></id>
        <collection property="roles" column="id" select="selectRolesByUserId"></collection>
        <collection property="permissions" column="id" select="selectPermissionsByUserId"></collection>
    </resultMap>
    <select id="selectRolesByUserId" resultType="java.lang.String">
        SELECT DISTINCT role.`name`
        FROM user_role
                 INNER JOIN role
                            on user_role.user_id = #{id} AND user_role.role_id = role.id
    </select>
    <select id="selectPermissionsByUserId" resultType="com.antake.pojo.Permission">
        SELECT DISTINCT permission.id,
                        permission.`name`,
                        permission.url,
                        permission.method,
                        permission.permission,
                        permission.parent_id,
                        permission.`order`,
                        permission.type,
                        permission.`status`,
                        permission.gmt_create,
                        permission.gmt_modified
        FROM role
                 INNER JOIN role_permission ON role.id = role_permission.role_id
                 INNER JOIN permission ON role_permission.permission_id = permission.id
                 INNER JOIN user_role ON role.id = user_role.role_id
            AND user_role.user_id = #{id}
            AND permission.deleted = 0
            AND permission.type = 0
    </select>
</mapper>
